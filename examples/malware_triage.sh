#!/bin/bash
# Quick malware triage - static analysis only (safe)

if [ $# -lt 1 ]; then
    echo "Usage: $0 <suspicious_binary>"
    exit 1
fi

BINARY="$1"
OUTPUT_DIR="triage_$(basename $BINARY)_$(date +%s)"

if [ ! -f "$BINARY" ]; then
    echo "Error: Binary not found: $BINARY"
    exit 1
fi

mkdir -p "$OUTPUT_DIR"
cd "$(dirname $0)/.."

echo "=== REKit Malware Triage ==="
echo "WARNING: Static analysis only - DO NOT EXECUTE"
echo "Binary: $BINARY"
echo "Output: $OUTPUT_DIR"
echo ""

# Basic info
echo "[1/6] Basic information..."
{
    echo "=== File Information ==="
    file "$BINARY"
    ls -lh "$BINARY"
    echo ""
    echo "=== Hashes ==="
    echo "MD5:    $(md5sum "$BINARY" | awk '{print $1}')"
    echo "SHA1:   $(sha1sum "$BINARY" | awk '{print $1}')"
    echo "SHA256: $(sha256sum "$BINARY" | awk '{print $1}')"
} > "$OUTPUT_DIR/file_info.txt"

# Structure
echo "[2/6] Parsing structure..."
FILE_TYPE=$(file "$BINARY" | grep -o "ELF\|PE32")
if [[ "$FILE_TYPE" == "ELF" ]]; then
    ./bin/elf-parser "$BINARY" > "$OUTPUT_DIR/structure.txt" 2>&1
else
    ./bin/pe-parser "$BINARY" > "$OUTPUT_DIR/structure.txt" 2>&1
fi

# Strings
echo "[3/6] Extracting strings..."
./bin/strings "$BINARY" 4 > "$OUTPUT_DIR/all_strings.txt" 2>&1

# Indicators
echo "[4/6] Finding indicators..."
{
    echo "=== URLs ==="
    grep -oE "https?://[a-zA-Z0-9./?=_-]+" "$OUTPUT_DIR/all_strings.txt" | sort -u
    echo ""
    echo "=== IP Addresses ==="
    grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" "$OUTPUT_DIR/all_strings.txt" | sort -u
    echo ""
    echo "=== Email Addresses ==="
    grep -oE "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b" "$OUTPUT_DIR/all_strings.txt" | sort -u
    echo ""
    echo "=== File Paths ==="
    grep -E "^(/[a-zA-Z0-9_.-]+)+/?$|^[A-Z]:\\\\|\.exe$|\.dll$|\.so$" "$OUTPUT_DIR/all_strings.txt" | sort -u | head -30
} > "$OUTPUT_DIR/indicators.txt"

# Suspicious strings
echo "[5/6] Finding suspicious patterns..."
{
    echo "=== Crypto/Encoding ==="
    grep -iE "base64|encrypt|decrypt|cipher|aes|rsa|md5|sha|crypt" "$OUTPUT_DIR/all_strings.txt"
    echo ""
    echo "=== Network ==="
    grep -iE "socket|connect|http|download|upload|curl|wget" "$OUTPUT_DIR/all_strings.txt"
    echo ""
    echo "=== Execution ==="
    grep -iE "exec|system|popen|shell|cmd|bash|/bin/sh" "$OUTPUT_DIR/all_strings.txt"
    echo ""
    echo "=== Persistence ==="
    grep -iE "cron|systemd|service|autostart|registry|startup" "$OUTPUT_DIR/all_strings.txt"
    echo ""
    echo "=== Credentials ==="
    grep -iE "password|passwd|pwd|token|key|secret|api|auth" "$OUTPUT_DIR/all_strings.txt"
} > "$OUTPUT_DIR/suspicious.txt" 2>&1

# Report
echo "[6/6] Generating report..."
{
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║           MALWARE TRIAGE REPORT                            ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
    echo "Sample: $BINARY"
    echo "Date: $(date)"
    echo ""
    
    echo "=== HASHES ==="
    grep -A3 "Hashes" "$OUTPUT_DIR/file_info.txt"
    echo ""
    
    echo "=== FILE TYPE ==="
    file "$BINARY"
    echo ""
    
    echo "=== RISK INDICATORS ==="
    URLS=$(grep -c "http" "$OUTPUT_DIR/indicators.txt" 2>/dev/null || echo 0)
    IPS=$(grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" "$OUTPUT_DIR/indicators.txt" 2>/dev/null | wc -l)
    CRYPTO=$(grep -ic "encrypt\|decrypt\|cipher" "$OUTPUT_DIR/suspicious.txt" 2>/dev/null || echo 0)
    NETWORK=$(grep -ic "socket\|connect\|http" "$OUTPUT_DIR/suspicious.txt" 2>/dev/null || echo 0)
    EXEC=$(grep -ic "exec\|system\|shell" "$OUTPUT_DIR/suspicious.txt" 2>/dev/null || echo 0)
    
    echo "URLs found: $URLS"
    echo "IP addresses: $IPS"
    echo "Crypto references: $CRYPTO"
    echo "Network references: $NETWORK"
    echo "Execution references: $EXEC"
    echo ""
    
    # Risk score
    RISK=$((URLS + IPS + CRYPTO + NETWORK + EXEC))
    echo "=== RISK SCORE ==="
    if [ $RISK -gt 20 ]; then
        echo "HIGH ($RISK indicators)"
    elif [ $RISK -gt 10 ]; then
        echo "MEDIUM ($RISK indicators)"
    else
        echo "LOW ($RISK indicators)"
    fi
    echo ""
    
    echo "=== TOP URLS ==="
    grep -A5 "URLs" "$OUTPUT_DIR/indicators.txt" | tail -5
    echo ""
    
    echo "=== TOP IP ADDRESSES ==="
    grep -A5 "IP Addresses" "$OUTPUT_DIR/indicators.txt" | tail -5
    echo ""
    
    echo "=== SUSPICIOUS STRINGS (sample) ==="
    head -20 "$OUTPUT_DIR/suspicious.txt"
    echo ""
    
    echo "=== RECOMMENDATIONS ==="
    if [ $RISK -gt 20 ]; then
        echo "⚠ HIGH RISK - Likely malicious"
        echo "  - Do NOT execute on production systems"
        echo "  - Analyze in isolated VM only"
        echo "  - Submit hashes to VirusTotal"
    elif [ $RISK -gt 10 ]; then
        echo "⚠ MEDIUM RISK - Potentially suspicious"
        echo "  - Further analysis recommended"
        echo "  - Use isolated environment"
    else
        echo "✓ LOW RISK - Appears benign"
        echo "  - May be legitimate software"
        echo "  - Verify with known-good hashes"
    fi
    
} > "$OUTPUT_DIR/REPORT.txt"

echo ""
echo "=== Triage Complete ==="
echo "Results saved to: $OUTPUT_DIR/"
echo ""
echo "Files created:"
echo "  - REPORT.txt        (main triage report)"
echo "  - file_info.txt     (basic file info)"
echo "  - structure.txt     (binary structure)"
echo "  - indicators.txt    (URLs, IPs, emails)"
echo "  - suspicious.txt    (suspicious strings)"
echo "  - all_strings.txt   (complete string dump)"
echo ""
echo "═══════════════════════════════════════════════════════════"
cat "$OUTPUT_DIR/REPORT.txt"
echo "═══════════════════════════════════════════════════════════"
